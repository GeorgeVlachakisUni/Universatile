@page "/modules"
@using Universitile01.Models;

<body>

	<AuthorizeView>
		<Authorized>
			<RadzenRow JustifyContent="JustifyContent.SpaceEvenly" AlignItems="Radzen.AlignItems.Center" Gap="0" Style="background-image:linear-gradient(180deg, rgb(83, 80, 56) 0%, #1d1d1d 90%)">
				@foreach (Module module in stModules)
				{
					<RadzenRow JustifyContent="JustifyContent.Center" AlignItems="Radzen.AlignItems.Center" Gap="0">
						<RadzenColumn Size="12" Style="justify-self:center; align-self:center">
							<RadzenCard Class="rz-my-12 rz-mx-auto" Style="width:480px; height:350; background-color:#12080c">
								<RadzenStack Orientation="Radzen.Orientation.Horizontal" JustifyContent="JustifyContent.Stretch" Gap="1rem" Class="rz-p-4">
									<RadzenStack Gap="0" Style="align-self:center">
										<RadzenText TextStyle="TextStyle.Overline" class="rz-display-flex rz-mt-2 rz-my-0"><b>Module</b></RadzenText>
										<RadzenText TextStyle="TextStyle.Body1"><b>@module.ModuleName</b></RadzenText>
										<RadzenText TextStyle="TextStyle.Body2">@module.ModuleId</RadzenText>
									</RadzenStack>
								</RadzenStack>
								<RadzenCard class="rz-background-color-danger-lighter rz-shadow-0 rz-border-radius-0 rz-p-8" style="height:185px; width:100%">
									<RadzenRow RowGap="0">
										<RadzenColumn SizeXS="8">
											<RadzenText TextStyle="TextStyle.Overline" class="rz-color-primary-light rz-display-flex rz-mt-4 rz-mb-0">Instructor</RadzenText>@*Display Instructor's name*@
											@*<RadzenText TextStyle="TextStyle.Body1">@module.CoursesCourse.CourseName</RadzenText>*@
											@*<RadzenText TextStyle="TextStyle.Overline" class="rz-color-primary-light rz-display-flex rz-mt-4 rz-mb-0">Direction</RadzenText>*@
											<RadzenText TextStyle="TextStyle.Body1">@module.ModuleDescription</RadzenText>
										</RadzenColumn>
										<RadzenColumn SizeXS="4">
											<MudButton Variant="@MudBlazor.Variant.Outlined" Style="width:105%" Color="Color.Secondary">Take Quiz</MudButton>
										</RadzenColumn>
										<RadzenColumn SizeXS="4">
											<MudButton Variant="@MudBlazor.Variant.Outlined" Color="Color.Secondary">Info</MudButton>
										</RadzenColumn>
									</RadzenRow>
								</RadzenCard>
								<br />
								<br />
							</RadzenCard>
						</RadzenColumn>
					</RadzenRow>
				}
			</RadzenRow>
		</Authorized>
	</AuthorizeView>

</body>

@code
{
	private string userId;
	private string connect = "Server=universtile.mysql.database.azure.com;User ID=azureuser;Password=7TI2K6O0O1ZL6SIUE6BDMGLDK*;Database=universitiledatabase;SslMode=Required;SslCa=DigiCertGlobalRootCA.crt.pem;TlsVersion=TLS 1.2";
	[CascadingParameter]
	private Task<AuthenticationState> authenticationStateTask { get; set; }
	private List<Module> stModules = new List<Module>();
	private List<PerosnalInfo> teachInfo = new List<PerosnalInfo>();

	protected override async Task OnInitializedAsync()
	{
		var userId = getUserId();
		async Task<string> getUserName()
		{
			var user = (await authenticationStateTask).User;
			return user.Identity.Name;
		}
		async Task<string> getUserId()
		{
			var user = (await authenticationStateTask).User;
			var userid = user.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;
			return userid;
		}
		string modstsql = "SELECT m.*, pi.first_name , pi.last_name  FROM modules m INNER JOIN courses c ON c.course_id = m.courses_course_id INNER JOIN students s ON s.courses_course_id = c.course_id INNER JOIN aspnetusers u ON u.Id = s.aspnetusers_Id INNER JOIN teachers t ON t.modules_module_id = m.module_id INNER JOIN personal_info pi ON pi.aspnetusers_Id = t.aspnetusers_Id WHERE u.Id = @userId";
		MySql.Data.MySqlClient.MySqlConnection connection = new MySql.Data.MySqlClient.MySqlConnection(connect);
		using (MySql.Data.MySqlClient.MySqlCommand command = new MySql.Data.MySqlClient.MySqlCommand(modstsql, connection))
		{
			command.Parameters.AddWithValue("@userId", userId.Result.ToString());
			connection.Open();
			MySql.Data.MySqlClient.MySqlCommand sqlcmd = new MySql.Data.MySqlClient.MySqlCommand(modstsql, connection);
			sqlcmd.CommandText = modstsql;
			sqlcmd.CommandType = CommandType.Text;
			MySql.Data.MySqlClient.MySqlDataReader rdr = sqlcmd.ExecuteReader();


			while (rdr.Read())
			{
				Module mod = new Module();
				mod.ModuleName = rdr["module_name"].ToString();

				PerosnalInfo prsinf = new PerosnalInfo();
				prsinf.FirstName = rdr["teacher_first_name"].ToString();
				prsinf.LastName = rdr["teacher_last_name"].ToString();
				stModules.Add(mod);
			}
			rdr.Close();
			connection.Close();
		}








	}
}
